# Scheduled Maintenance Pipeline
# Requirements: 93 - CI/CD pipeline
# Requirements: 100 - Development environment setup

name: Scheduled Maintenance

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Maintenance task to run'
        required: true
        type: choice
        options:
          - all
          - cleanup-images
          - security-scan
          - dependency-update-check

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Cleanup old container images
  cleanup-images:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'cleanup-images'
    permissions:
      packages: write
    steps:
      - name: Delete old backend images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'backend'
          package-type: 'container'
          min-versions-to-keep: 15
          delete-only-untagged-versions: 'true'
        continue-on-error: true

      - name: Delete old frontend images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'frontend'
          package-type: 'container'
          min-versions-to-keep: 15
          delete-only-untagged-versions: 'true'
        continue-on-error: true

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'security-scan'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Run npm audit
        run: |
          npm ci
          npm audit --audit-level=moderate || true

  # Check for dependency updates
  dependency-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'dependency-update-check'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated dependencies
        id: outdated
        run: |
          echo "## Outdated Dependencies" > outdated-report.md
          echo "" >> outdated-report.md
          npm outdated --json > outdated.json || true
          
          if [[ -s outdated.json ]]; then
            echo "| Package | Current | Wanted | Latest |" >> outdated-report.md
            echo "|---------|---------|--------|--------|" >> outdated-report.md
            cat outdated.json | jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' >> outdated-report.md
            echo "has-outdated=true" >> $GITHUB_OUTPUT
          else
            echo "All dependencies are up to date!" >> outdated-report.md
            echo "has-outdated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for outdated dependencies
        if: steps.outdated.outputs.has-outdated == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('outdated-report.md', 'utf8');
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated'
            });
            
            const existingIssue = issues.data.find(i => i.title.includes('Dependency Update'));
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `${report}\n\n_Last updated: ${new Date().toISOString()}_`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“¦ Dependency Update Report',
                body: `${report}\n\n_Generated: ${new Date().toISOString()}_`,
                labels: ['dependencies', 'automated', 'maintenance']
              });
            }

  # Cleanup old workflow runs
  cleanup-workflows:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.task == 'all'
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
